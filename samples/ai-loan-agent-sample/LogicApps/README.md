# Local Development Setup

This guide provides step-by-step instructions for setting up local development environment for this Logic Apps Standard project.

> üé• **New to this sample?** [Watch the demo video](https://youtu.be/rR1QjQTfCCg) to see the complete AI Loan Agent workflow in action before setting up your development environment.

## Overview

**End-to-End Setup Summary:**
1. Run `deploy.ps1` to create Azure infrastructure
2. Configure Microsoft 365 (Forms, Teams, authorize API connections) - *during deployment*
3. Setup database schema and managed identity access
4. Configure local development environment (`local.settings.json`) - **AUTO-GENERATED by deploy.ps1**
5. Deploy workflows to Azure using VS Code
6. Map form field IDs using `update-form-field-mappings.ps1` - **Updates local.settings.json, parameters.json, and Azure app settings**
7. Test the complete loan approval flow

This guide focuses on **Step 4** - local development configuration. The `deploy.ps1` script **automatically generates** your `local.settings.json` file with values from your deployed resources!

**Note**: Logic Apps Standard uses a three-layer parameter resolution system:
1. `workflow.json` - Defines parameters with types and defaults
2. `parameters.json` - Maps parameters to app settings using `@appsetting()`
3. Azure app settings - Contains actual runtime values

All three layers must be configured for workflow parameters to resolve correctly.

The `local.settings.json` file contains configuration settings required for local development. This file should **never** be committed to source control as it contains sensitive connection strings and local-specific paths.

The `parameters.json` file maps workflow parameters to app settings at runtime. This file is included in deployments and must contain entries for all workflow parameters defined in `workflow.json`.

## Quick Setup Steps

### 1. Check Auto-Generated local.settings.json

‚ú® **The enhanced `deploy.ps1` script automatically creates `local.settings.json` for you!**

After running `deploy.ps1`, check if the file was created:
```powershell
# Navigate to the LogicApps folder
cd LogicApps

# Check if local.settings.json exists
Test-Path local.settings.json
```



### 2. Verify Auto-Generated Settings

üîç **Review the auto-generated values** - most should be correctly populated:

‚úÖ **Pre-configured by deploy.ps1:**
- `WORKFLOWS_SUBSCRIPTION_ID` - Your Azure subscription ID
- `WORKFLOWS_RESOURCE_GROUP_NAME` - Your resource group name  
- `agent_openAIEndpoint` - Azure OpenAI service endpoint
- `agent_openAIKey` - Azure OpenAI access key
- `agent_ResourceID` - Azure OpenAI resource ID
- `sql_connectionString` - SQL Database connection string
- `riskAssessmentAPI_SubscriptionKey`, `employmentValidationAPI_SubscriptionKey`, `creditCheckAPI_SubscriptionKey`, `demographicVerificationAPI_SubscriptionKey` - All API Management subscription keys
- `PolicyDocumentURL` - Policy document SAS URL
- Basic workflow configuration values

üîß **Manual configuration still required:**
- `ProjectDirectoryPath` - Your local LogicApps folder path
- `TeamsGroupId` / `TeamsChannelId` - From your Teams workspace  
- `FormsFormId` - Microsoft Forms Form ID from your created form
- `DemoUserEmail` - Your email for notifications

| Setting Key | Description | Where to Find | Example |
|-------------|-------------|---------------|---------|
| `ProjectDirectoryPath` | Local path to LogicApps folder | Your local file system | `C:\\projects\\ai-loan-agent\\LogicApps` |
| `WORKFLOWS_SUBSCRIPTION_ID` | Azure subscription ID | Azure Portal ‚Üí Subscriptions | `12345678-1234-1234-1234-123456789012` |
| `WORKFLOWS_RESOURCE_GROUP_NAME` | Target resource group name | Azure Portal ‚Üí Resource groups | `ai-loan-agent-rg` |
| `agent_openAIEndpoint` | Azure OpenAI service endpoint | Azure Portal ‚Üí OpenAI ‚Üí Keys and Endpoint | `https://myopenai.openai.azure.com/` |
| `agent_openAIKey` | Azure OpenAI access key | Azure Portal ‚Üí OpenAI ‚Üí Keys and Endpoint | `abc123def456...` |
| `agent_ResourceID` | Azure OpenAI resource ID | Azure Portal ‚Üí OpenAI ‚Üí Properties | `/subscriptions/.../resourceGroups/.../providers/Microsoft.CognitiveServices/accounts/myopenai` |
| `sql_connectionString` | SQL Database connection string | Azure Portal ‚Üí SQL Database ‚Üí Connection strings | `Server=tcp:myserver.database.windows.net,1433;...` |
| `riskAssessmentAPI_SubscriptionKey` | Risk assessment API key | Azure Portal ‚Üí API Management ‚Üí Subscriptions | `abc123...` |
| `employmentValidationAPI_SubscriptionKey` | Employment validation API key | Azure Portal ‚Üí API Management ‚Üí Subscriptions | `def456...` |
| `creditCheckAPI_SubscriptionKey` | Credit check API key | Azure Portal ‚Üí API Management ‚Üí Subscriptions | `ghi789...` |
| `demographicVerificationAPI_SubscriptionKey` | Demographics API key | Azure Portal ‚Üí API Management ‚Üí Subscriptions | `jkl012...` |
| `PolicyDocumentURL` | Policy document SAS URL | Azure Storage ‚Üí Generate SAS | `https://mystorage.blob.core.windows.net/...` |
| `FormsFormId` | Microsoft Forms Form ID | Microsoft Forms form URL | `your-forms-form-id-here` |
| `teams-GroupId` | Microsoft Teams group ID | Teams channel URL | `[your-teams-group-id]` |
| `teams-ChannelId` | Microsoft Teams channel ID | Teams channel URL | `[your-teams-channel-id]` |
| `DemoUserEmail` | Demo email for notifications | Your email address | `[your-email]` |

### 3. Pre-configured Values (Do Not Modify)

These values are already set correctly and should remain unchanged:
- `AzureWebJobsStorage`: `"UseDevelopmentStorage=true"`
- `APP_KIND`: `"workflowApp"`
- `FUNCTIONS_WORKER_RUNTIME`: `"dotnet"`
- `FUNCTIONS_INPROC_NET8_ENABLED`: `"1"`

## Detailed Configuration Guide

### ‚ú® Auto-Generated Configuration (New!)

The enhanced `deploy.ps1` script now automatically populates most configuration values. Here's what you get automatically:

**Azure Resource Configuration (Auto-Generated):**
- ‚úÖ **Azure OpenAI**: Endpoint, key, and resource ID from your deployed OpenAI service
- ‚úÖ **SQL Database**: Connection string with managed identity authentication
- ‚úÖ **API Management**: All four API subscription keys automatically retrieved
- ‚úÖ **Storage**: Policy document SAS URL with 1-year expiration
- ‚úÖ **Workflow Settings**: Subscription ID, resource group, location

**Still Requires Manual Configuration:**
- üîß **ProjectDirectoryPath**: Your local file system path
- üîß **Teams Integration**: Group ID and Channel ID from your Teams workspace  
- üîß **Demo Email**: Your email address for notifications

### Manual Configuration Steps

#### 1. Project Directory Path

Update the local file system path to your LogicApps folder:
```json
"ProjectDirectoryPath": "C:\\\\projects\\\\ai-loan-agent\\\\LogicApps"
```

#### 2. Teams Configuration (If Using Teams Integration)

Extract Team Group ID and Channel ID from Teams channel URL:
1. Open Teams channel in browser
2. Copy URL and extract IDs from the path
3. Update both `TeamsGroupId` and `teams-GroupId` with the same value
4. Update both `TeamsChannelId` and `teams-ChannelId` with the same value

#### 4. Microsoft Forms Configuration

Extract the Form ID from your Microsoft Forms form URL:
1. Open your Microsoft Forms form in browser
2. Copy the Form ID from the URL (the long string after `/forms/`)
3. Update the FormsFormId setting:
```json
"FormsFormId": "your-actual-form-id-here"
```

#### 4. Demo Email Address

Update with your email address for testing:
```json
"DemoUserEmail": "your-email@yourcompany.com"
```

### Microsoft 365 Connections (Auto-Created)

The deployment script automatically creates Microsoft 365 API connections in Azure, but they require manual authorization:

1. **Connections Auto-Created by deploy.ps1**:
   - `formsConnection` - Microsoft Forms connector
   - `teamsConnection` - Microsoft Teams connector  
   - `outlookConnection` - Outlook connector
   - Connection configuration values auto-populated in `local.settings.json`

2. **Manual Authorization Still Required**:
   - Azure Portal ‚Üí Resource Groups ‚Üí [your-resource-group]
   - Click each connection ‚Üí "Edit API Connection" ‚Üí "Authorize"
   - Sign in with your Microsoft 365 account when prompted

3. **Connection Configuration (Auto-Generated)**:
   - Runtime URLs are auto-generated after authorization
   - Connection keys use `@connectionKey('connection-name')` format
   - These values are automatically populated in your `local.settings.json`

üìù **Note**: Authorization must be done manually for security compliance, but all connection setup and configuration is automated.

## Next Steps: Deploy to Azure

After completing local.settings.json configuration:

1. **Open in VS Code**: Open the LogicApps folder in VS Code
2. **Install Extension**: Ensure Azure Logic Apps extension is installed
3. **Deploy Workflows**: Right-click LogicApps folder ‚Üí "Deploy to Logic App in Azure"
4. **Select Target**: Choose your deployed Logic App resource
5. **Test Deployment**: Verify workflows appear in Azure Portal

## Sample Configuration

‚ú® **Your `local.settings.json` should look similar to this after running the enhanced `deploy.ps1`:**

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "APP_KIND": "workflowApp",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet",
    "FUNCTIONS_INPROC_NET8_ENABLED": "1",
    
    // ‚ö†Ô∏è MANUAL: Update with your local path
    "ProjectDirectoryPath": "C:\\\\projects\\\\ai-loan-agent\\\\LogicApps",
    
    // ‚úÖ AUTO-GENERATED: Populated by deploy.ps1
    "WORKFLOWS_SUBSCRIPTION_ID": "12345678-1234-1234-1234-123456789012",
    "WORKFLOWS_LOCATION_NAME": "eastus2",
    "WORKFLOWS_RESOURCE_GROUP_NAME": "ai-loan-agent-rg",
    "agent_openAIEndpoint": "https://ai-loan-agent-openai-1234.openai.azure.com/",
    "agent_openAIKey": "your-actual-openai-key-auto-populated",
    "agent_ResourceID": "/subscriptions/.../ai-loan-agent-openai-1234",
    "sql_connectionString": "Server=tcp:ai-loan-agent-sqlserver-1234.database.windows.net,1433;Initial Catalog=ai-loan-agent-db;Authentication=Active Directory Managed Identity;Encrypt=True;",
    "riskAssessmentAPI_SubscriptionKey": "auto-generated-key-1",
    "employmentValidationAPI_SubscriptionKey": "auto-generated-key-1",
    "creditCheckAPI_SubscriptionKey": "auto-generated-key-2",
    "demographicVerificationAPI_SubscriptionKey": "auto-generated-key-2",
    "PolicyDocumentURL": "https://ailoanagentblob20251002.blob.core.windows.net/policies/loan-policy.txt?sp=r&st=...",
    
    // ‚úÖ AUTO-GENERATED: Microsoft 365 connection configuration
    "formsConnection-ConnectionRuntimeUrl": "auto-generated-runtime-url",
    "teamsConnection-ConnectionRuntimeUrl": "auto-generated-runtime-url",
    "outlookConnection-ConnectionRuntimeUrl": "auto-generated-runtime-url",
    "formsConnection-connectionKey": "@connectionKey('formsConnection')",
    "teamsConnection-connectionKey": "@connectionKey('teamsConnection')",
    "outlookConnection-connectionKey": "@connectionKey('outlookConnection')",
    
    // ‚ö†Ô∏è MANUAL: Update with your Teams workspace IDs
    "TeamsGroupId": "[your-teams-group-id]",
    "TeamsChannelId": "[your-teams-channel-id]",
    "teams-GroupId": "[your-teams-group-id]",
    "teams-ChannelId": "[your-teams-channel-id]",
    
    // ‚ö†Ô∏è MANUAL: Update with your Microsoft Forms Form ID
    "FormsFormId": "[your-forms-form-id]",
    
    // ‚ö†Ô∏è MANUAL: Update with your email
    "DemoUserEmail": "[your-email]"
  }
}
```

üîç **Key Points:**
- ‚úÖ **Most values auto-populated** by the enhanced deployment script
- ‚ö†Ô∏è **4-5 values require manual update** (marked above)
- üîí **Unique resource names** (note the `-1234` suffixes) prevent conflicts
- üîó **Connection references** use `@connectionKey()` format for security

## Next Steps: Deploy to Azure

After completing local.settings.json configuration:

1. **Open in VS Code**: Open the LogicApps folder in VS Code
2. **Install Extension**: Ensure Azure Logic Apps extension is installed
3. **Deploy Workflows**: Right-click LogicApps folder ‚Üí "Deploy to Logic App in Azure"
4. **Select Target**: Choose your deployed Logic App resource
5. **Test Deployment**: Verify workflows appear in Azure Portal

> üí° **Tip**: This corresponds to **Step 6** in the main deployment guide. After deployment, proceed to **Step 7: End-to-End Testing**.

## Verification Steps

1. **Test Local Run**: Use VS Code Azure Logic Apps extension to start the local runtime
2. **Check Connections**: Verify all connections are working in the Logic Apps Designer
3. **Test Workflows**: Run a simple test of each workflow to ensure proper configuration

## Important Security Notes

- ‚ö†Ô∏è **Never commit `local.settings.json` to source control**
- üîê **Use proper Azure RBAC permissions instead of connection strings when possible**
- üîÑ **Rotate keys regularly and update local settings accordingly**
- üîí **Microsoft 365 connections use OAuth - no passwords stored locally**
- üõ°Ô∏è **Managed identity used for SQL authentication - no connection string passwords**

## Troubleshooting

## Troubleshooting

### Configuration Issues (Mostly Resolved!)

‚ú® **Good News**: The enhanced `deploy.ps1` script eliminates most configuration issues by auto-generating correct values!

### Common Issues

**Missing local.settings.json:**
- **Cause**: Deploy script may have failed before completion
- **Solution**: Re-run `deploy.ps1` - it's idempotent and will resume where it left off
- **Fallback**: Copy `cloud.settings.json` to `local.settings.json` and configure manually

**File Path Issues (Windows):**
- Ensure paths use double backslashes (`\\\\`) or forward slashes (`/`)
- Example: `C:\\\\projects\\\\myapp` or `C:/projects/myapp`
- **Auto-generated template**: Uses correct format, just update the path

**Connection Failures:**
- **Azure Resources**: Auto-generated connection strings should be correct
- **Microsoft 365**: Verify connections are authorized in Azure Portal
- **Firewall**: Check Azure resources allow access from your IP

**Microsoft 365 Connection Issues:**
- **Unauthorized errors**: Re-authorize connections in Azure Portal ‚Üí "Edit API Connection"
- **Connection not found**: Verify deploy.ps1 completed successfully  
- **Authentication failures**: Ensure you have appropriate Microsoft 365 permissions
- **Teams/Forms access**: Check your account has access to the target workspace/form

**Microsoft Forms Configuration Issues:**
- **Missing Form ID**: Ensure `FormsFormId` is correctly set in local.settings.json
- **Invalid Form ID**: Verify the Form ID is copied correctly from the Forms URL
- **Form Access**: Ensure the form is accessible and published
- **Webhook Registration**: Form must be created before deploying the workflow

**Workflow Parameter Resolution Issues:**
- **"Parameter not found" errors**: Workflow parameters require configuration in THREE places:
  1. `workflow.json` - Parameter definition with type and default
  2. `parameters.json` - Mapping to app settings via `@appsetting('ParameterName')`
  3. Azure app settings - Actual runtime values
- **Solution**: Run `update-form-field-mappings.ps1` to configure all three layers automatically
- **Manual verification**: Check that parameters.json contains entries for all workflow parameters
- **Restart required**: Logic App must be restarted after app settings changes

**SQL Authentication Issues:**
- **Auto-generated config**: Connection string should be correct from deploy.ps1
- **Managed identity**: Verify `create-managed-identity-user.sql` was executed
- **Database permissions**: Run database setup scripts if access denied

**Azure OpenAI Issues:**
- **Auto-generated config**: Endpoint and keys should be correct from deploy.ps1
- **Model deployment**: Verify GPT-4.1 model deployment exists
- **Quota**: Check OpenAI resource has sufficient quota

**Teams Integration Issues:**
- **Manual config required**: Group ID and Channel ID must be updated manually
- **Format verification**: Ensure IDs are correct format from Teams URL
- **App permissions**: Check Teams workspace allows external apps

**Runtime Issues:**
- Verify .NET and Azure Functions Core Tools are installed
- Check VS Code Azure Logic Apps extension is up to date
- Review terminal output for specific error messages

### Getting Help

- **Deployment Issues**: See `../Deployment/TROUBLESHOOTING.md` for comprehensive deployment troubleshooting
- **Runtime Issues**: Check Azure Logic Apps runtime logs in VS Code terminal
- **Connection Issues**: Review connection test results in Logic Apps Designer
- **Resource Issues**: Monitor Azure resource health in Azure Portal
- **Telemetry**: Use Azure Application Insights for detailed telemetry
